---
title: "CAISC"
author: "SG,JK,LM"
date: "04/01/2021"#"`r Sys.Date()`"
abstract: Although both copy number variations (CNVs) and single nucleotide variations (SNVs) detected by scRNA-seq are used to study intratumor heterogeneity and detect clonal groups, a software to integrate two types of data in the same cells is unavailable. We have developed CAISC, an R package for scRNA-seq data analysis that clusters single cells into distinct subclones through integrating CNV and SNV genotype matrices with an entropy weighted approach. The CAISC package presents a powerful application for integration of CNV and SNV data from scRNA-seq to identify clonal clusters, with elevated accuracy compared to using one type of data. It also allows users to interactively examine clonal assignments.
output: 
  rmarkdown::html_document:
    theme: united
    highlight: tango
    toc: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: CAISC.enl
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# 1. Installation
Install all packages in the latest version of [R](https://www.r-project.org/).
```{r, eval=FALSE}
devtools::install_github("lizamathews/CAISC")
```
```{r load}
library(CAISC)
```

# 2. Questions & issues
If you have any questions or problems, please feel free to open a new issue [here](). You can also email the maintainers of the package -- the contact information is below.

* [Shouguo Gao]() (shouguo dot gao at nih dot gov)
  <br>
  NHLBI Hematopoiesis and Bone Marrow Failure Lab, Bethesda, MD

* [Jeerthi Kannan]() (jeerthi 98 at gmail dot com)
  <br>
  NHLBI
  
* [Liza Mathews]() (liza mathews 5 at gmail dot com)
  <br>
  NHLBI

# 3. CAISC Analysis pipeline
## 3.1 Overall pipeline 

```{r, out.width = "1000px", fig.align = "center", echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/lizamathews/CAISC/master/figure1.jpg")
```
  **Figure 1**. A flowchart outlining the procedures for CAISC.

## 3.2 Generate SNV Mutation Distance Matrix

Create a matrix of SNV mutations from a VCF file of mutations that appear in a minimal number of cells.
```{r SNV matrix, eval=FALSE}
# create SNV matrix of mutations
createSNVMatrix("GSE57872_merged.vcf", "DENDRO_input_10mutations.rda", "SRR_ID.txt", "snvDistanceMatrix.csv")
```

## 3.3 Generate CNV Mutation Distance Matrix

Then, create a matrix of CNV mutations from a raw counts matrix containing assigned read counts, a sample annotation file, and a gene ordering file.
```{r CNV matrix, eval=FALSE}
library(igraph)
library(leiden)
library(leidenAlg)
# create CNV matrix of mutations
createCNVMatrix("expressionmatrix_28_29.txt", "annotationCell_28_29.txt", "annotationGene_28_29.txt", "CSC", "GSE57872.RData")
```

## 3.4 Generate Integrated Distance Matrix from SNV and CNV Mutations

Next, create an integrated matrix with the created snv and cnv matrices as input.
```{r integrated matrix}
#load snv and cnv matrices
snv_matrix <- as.matrix(read.csv("snvDistanceMatrix.csv", row.names = 1, header = TRUE))
cnv_matrix <- as.matrix(read.csv("CNVdistMatrix.zscore.csv", row.names = 1, header = TRUE))

# create and save integrated matrix
integrated_matrix <- createIntegratedMatrix(cnv_matrix, snv_matrix)
write.csv(integrated_matrix, file="integratedMatrix.csv", quote = FALSE)
```

## 3.5 Create and Examine Interactive Complex Heatmap

Create an interactive complex heatmap from the snv, cnv, integrated matrices, infercnv object, and the same gene ordering file used to create the cnv matrix. Use Shiny web app to interactively examine the complex heatmap.
```{r interactive complex heatmap}
# create interactive complex heatmap
heatmap <- createComplexHeatmap(snv_matrix, cnv_matrix, integrated_matrix, "GSE57872.RData", "../data/annotationGene_28_29.txt")

library(InteractiveComplexHeatmap)
# use shiny to examine heatmap
ht_shiny(heatmap)
```

## 3.6 Tanglegram

Create tanglegram
```{r}
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering visualization
library(dendextend) # for comparing two dendrograms

snv_matrix<-(snv_matrix-mean(snv_matrix))/sd(snv_matrix)
overlapCells<-intersect(row.names(snv_matrix), rownames(cnv_matrix))
#png("TangleFigures.png", width=12000, height = 6000, res=200)

clust1=hclust(as.dist(snv_matrix[overlapCells,overlapCells]),method='ward.D')
dend1=as.dendrogram(clust1)

clust2=hclust(as.dist(cnv_matrix[overlapCells,overlapCells]),method='ward.D')
dend2=as.dendrogram(clust2)

tanglegram(dend1, dend2, margin_inner = 10)
#dev.off()

cor.dendlist(dendlist(dend1=dend1, dend2=dend2))
```


### The package works for R >=4.1

# 5. Session info

```{r sessionInfo}
sessionInfo()
```

# 6. References

